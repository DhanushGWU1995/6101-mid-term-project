---
title: "Unveiling the factors significantly associated with coronary heart disease diagnosis?"
author: |
  Team Confusion Matrix Mafia:
  
  Dhanush Mathivanan, Heng Jui Chu, Nikhilesh Dhavale, Adithya Karande
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide 
    theme: cerulean        
    css: custom.css        
---

```{r setup, include=FALSE}
library(ezids)
library(ggplot2)
library(dplyr)
library(tidyr)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
options(scientific = TRUE, digits = 3)
```

---

# Abstract

This study examines lifestyle and health factors linked to coronary heart disease (CHD) in people under 70 using a large survey dataset. After data cleaning and handling missing values, we use t-tests and chi-square tests to analyze age, sex, BMI, smoking, diabetes, exercise, and health status. Results show higher age, BMI, diabetes, and smoking increase CHD risk, while exercise and better health lower it. These findings highlight the importance of healthy behaviors for CHD prevention.

# Motivation for Topic Selection

Coronary heart disease is a major global health issue. We chose this topic to better understand risk factors for CHD and support prevention. Identifying modifiable risks and lifestyle choices can help reduce the burden of heart disease.

# Prior Research and Analysis

Prior studies, including the [Framingham Heart Study](https://www.framinghamheartstudy.org/) and [INTERHEART](https://www.phri.ca/research/interheart/), have shown that age, sex, diabetes, smoking, obesity, inactivity, and poor health are key CHD risk factors. The BRFSS dataset is widely used to track these risks and evaluate interventions. Our study uses recent BRFSS 2024 data and statistical methods to clarify the importance of these factors today.

# Dataset Description

We used data from the 2024 BRFSS, a national CDC survey of US adults. The dataset covers health behaviors, conditions, and demographics, with over 300 variables. More details: [CDC BRFSS Annual Data 2024](https://www.cdc.gov/brfss/annual_data/annual_2024.html).

# Variables Used for Analysis

The following variables were selected based on clinical relevance and prior research indicating their association with coronary heart disease (CHD):

- **Age**: Age group of the respondent
- **Sex**: Biological sex
- **Diabetes_Status**: Diabetes diagnosis status
- **Smoking_Status**: Lifetime smoking status
- **BMI_Category_Alt**: BMI category (Underweight, Normal, Overweight, Obese)
- **Exercise_Past_30_Days**: Physical activity in the past 30 days
- **Coronary_Heart_Disease**: CHD diagnosis status (outcome variable)
- **Heart_Attack_History**: History of heart attack
- **General_Health_Status**: Self-reported general health status
- **BMI_Value**: Calculated BMI value

# Variable Selection Criteria

These variables are established CHD risk factors or predictors, supported by research and guidelines. We include demographic, behavioral, metabolic, and health measures for a comprehensive analysis. Variables with high missingness were excluded for reliability.

---

# Data Loading & Preparation

```{r, results='asis'}
# Load necessary libraries
library(kableExtra)
library(knitr)

Heart_data <- data.frame(read.csv("BRFSS_2024_Readable_Columns.csv"))

# Variable transformation
Heart_data$Age_Group_5yr <- factor(
  Heart_data$Age_Group_5yr, levels = 1:13,
  labels = c("18-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80+")
)
Heart_data$Sex <- factor(Heart_data$Sex, levels = c(1, 2), labels = c("Male", "Female"))
Heart_data$Diabetes_Status <- factor(Heart_data$Diabetes_Status, levels = c(1, 2, 3, 4), labels = c("Yes", "Yes/borderline", "Yes/pregnancy only", "No"))
Heart_data$Smoking_Status <- factor(Heart_data$Smoked_100_Cigarettes_Lifetime, levels = c(1, 2), labels = c("Yes", "No"))
Heart_data$BMI_Category_Alt <- factor(Heart_data$BMI_Category_Alt, levels = c(1, 2, 3, 4), labels = c("Underweight", "Normal Weight", "Overweight", "Obese"))
Heart_data$Exercise_Past_30_Days <- factor(Heart_data$Exercise_Past_30_Days, levels = c(1, 2), labels = c("Yes", "No"))
# Heart_data$CVD_Stroke_History <- factor(Heart_data$CVD_Stroke_History, levels = c(1, 2), labels = c("Yes", "No"))
Heart_data$Coronary_Heart_Disease <- factor(Heart_data$Coronary_Heart_Disease, levels = c(1, 2), labels = c("Yes", "No"))
Heart_data$Heart_Attack_History <- factor(Heart_data$Heart_Attack_History, levels = c(1, 2), labels = c("Yes", "No"))
Heart_data$General_Health_Status <- factor(Heart_data$General_Health_Status, levels = c(1, 2, 3, 4, 5), labels = c("Excellent", "Very Good", "Good", "Fair", "Poor"))
Heart_data$BMI_Value <- Heart_data$BMI_Category / 100

# Add state_code
Heart_data$State_Code <- factor(Heart_data$State_Code)

names(Heart_data)[names(Heart_data) == "Age_Group_5yr"] <- "Age"

# Select only the 14 key variables
selected_vars <- c(
  "Age", "Sex", "Diabetes_Status", "Smoking_Status", "BMI_Category_Alt",
  "Exercise_Past_30_Days", "Coronary_Heart_Disease",
  "Heart_Attack_History", "General_Health_Status", "BMI_Value", "State_Code"
)
Heart_data <- Heart_data[, selected_vars]

# Display first few rows of the dataset in a styled box
kable(head(Heart_data[, 1:6]), caption = "Initial Dataset Preview with few variables", align = 'c', format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"), full_width = FALSE, position = "left")
```

---

# Missing Value Analysis

```{r, results='asis'}
missing_analysis <- data.frame(
  Variable = names(Heart_data),
  Missing_Count = sapply(Heart_data, function(x) sum(is.na(x))),
  Missing_Percent = sapply(Heart_data, function(x) round((sum(is.na(x)) / length(x)) * 100, 2))
)
missing_analysis <- missing_analysis[order(-missing_analysis$Missing_Percent), ]

kable(
  missing_analysis,
  caption = "Missing Value Summary for Selected Variables",
  align = 'c',
  format = "html"
) %>%
  kable_styling(
    bootstrap_options = c("striped", "bordered", "hover"),
    full_width = FALSE,
    position = "left"
  )
```

---

# Data Cleaning

## Missing Value Treatment (Imputation - Median for continuous variables)
```{r, results='asis'}
rows_initial <- nrow(Heart_data)
Heart_clean <- Heart_data

# Impute continuous variables with 5-20% missing using median
continuous_vars <- c("BMI_Value")
for(var in continuous_vars) {
  if(var %in% names(Heart_clean)) {
    missing_before <- sum(is.na(Heart_clean[[var]]))
    missing_pct <- mean(is.na(Heart_clean[[var]])) * 100
    if(missing_pct >= 5 && missing_pct <= 20) {
      var_median <- median(Heart_clean[[var]], na.rm = TRUE)
      Heart_clean[[var]][is.na(Heart_clean[[var]])] <- var_median
      cat(sprintf("Imputed %d missing values in %s with median (%.2f)\n", missing_before, var, var_median))
    }
  }
}

# Impute missing BMI_Category_Alt based on BMI_Value
if("BMI_Category_Alt" %in% names(Heart_clean) && "BMI_Value" %in% names(Heart_clean)) {
  missing_idx <- which(is.na(Heart_clean$BMI_Category_Alt) & !is.na(Heart_clean$BMI_Value))
  if(length(missing_idx) > 0) {
    bmi_vals <- Heart_clean$BMI_Value[missing_idx]
    bmi_cat <- cut(bmi_vals,
                  breaks = c(-Inf, 18.5, 24.9, 29.9, Inf),
                  labels = c("Underweight", "Normal Weight", "Overweight", "Obese"),
                  right = TRUE)
    Heart_clean$BMI_Category_Alt[missing_idx] <- bmi_cat
    cat(sprintf("Imputed %d missing BMI_Category_Alt values based on BMI_Value\n", length(missing_idx)))
  }
}
```

---

## Outlier Removal and Invalid Data Handling
```{r, results='asis'}

# Remove invalid General Health Status responses
if("General_Health_Status" %in% names(Heart_clean)) {
  rows_before <- nrow(Heart_clean)
  valid_health <- Heart_clean$General_Health_Status %in% c("Excellent", "Very Good", "Good", "Fair", "Poor")
  Heart_clean <- Heart_clean[valid_health, ]
  cat(sprintf("Removed %d rows with invalid General Health Status responses\n", rows_before - nrow(Heart_clean)))
}

# Remove invalid Exercise_Past_30_Days responses
if ("Exercise_Past_30_Days" %in% names(Heart_clean)) {
  rows_before <- nrow(Heart_clean)
  valid_exercise <- Heart_clean$Exercise_Past_30_Days %in% c("Yes", "No")
  Heart_clean <- Heart_clean[valid_exercise, ]
  cat(sprintf("Removed %d rows with invalid Exercise_Past_30_Days responses\n", rows_before - nrow(Heart_clean)))
}

# Remove Age groups above 69 years
if ("Age" %in% names(Heart_clean)) {
  rows_before <- nrow(Heart_clean)
  valid_age_groups <- c("18-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69")
  Heart_clean <- Heart_clean[Heart_clean$Age %in% valid_age_groups, ]
  cat(sprintf("Removed %d rows with Age above 69 years\n", rows_before - nrow(Heart_clean)))
}

# Remove Age label above 69 
Heart_clean$Age <- factor(Heart_clean$Age)

# Remove rows with missing critical variables
critical_vars <- c("Coronary_Heart_Disease", "General_Health_Status", "Sex", "Exercise_Past_30_Days", "Diabetes_Status", "Smoking_Status", "BMI_Value", "BMI_Category_Alt", "Age")
available_critical <- critical_vars[critical_vars %in% names(Heart_clean)]
rows_before <- nrow(Heart_clean)
Heart_clean <- Heart_clean[complete.cases(Heart_clean[available_critical]), ]
cat(sprintf("Removed %d rows with missing critical variables\n", rows_before - nrow(Heart_clean)))

# Outlier treatment for BMI_Value
if("BMI_Value" %in% names(Heart_clean)) {
  rows_before <- nrow(Heart_clean)
  bmi_outliers <- which(Heart_clean$BMI_Value < 10 | Heart_clean$BMI_Value > 70)
  if(length(bmi_outliers) > 0) {
    Heart_clean <- Heart_clean[-bmi_outliers, ]
    cat(sprintf("Removed %d rows with impossible BMI values (<10 or >70)\n", rows_before - nrow(Heart_clean)))
  }
}
```

---

## Handling CHD Distribution Class Imbalance based on Geographic Location

```{r, results='asis'}
if("State_Code" %in% names(Heart_clean) && "Coronary_Heart_Disease" %in% names(Heart_clean)) {
  # For each Yes CHD case, randomly sample a No CHD case from the same State_Code
  chd_yes_cases <- Heart_clean %>% filter(Coronary_Heart_Disease == "Yes")
  chd_no_cases <- Heart_clean %>% filter(Coronary_Heart_Disease == "No")
  
  set.seed(123)  # For reproducibility
  # To prevent duplicates, keep track of used No-CHD indices
  used_no_indices <- c()
  sampled_no_cases_list <- vector("list", nrow(chd_yes_cases))
  for (i in seq_len(nrow(chd_yes_cases))) {
    state <- chd_yes_cases$State_Code[i]
    # Get available No-CHD cases for this state, excluding already used
    no_cases_state <- chd_no_cases %>% filter(State_Code == state)
    if (nrow(no_cases_state) > 0) {
      available <- setdiff(seq_len(nrow(no_cases_state)), used_no_indices)
      # Map to global indices
      global_indices <- which(chd_no_cases$State_Code == state)
      available_global <- setdiff(global_indices, used_no_indices)
      if (length(available_global) > 0) {
        pick <- sample(available_global, 1)
        used_no_indices <- c(used_no_indices, pick)
        sampled_no_cases_list[[i]] <- chd_no_cases[pick, ]
      } else {
        # If all state No-CHD cases used, sample from all unused No-CHD
        available_global <- setdiff(seq_len(nrow(chd_no_cases)), used_no_indices)
        if (length(available_global) > 0) {
          pick <- sample(available_global, 1)
          used_no_indices <- c(used_no_indices, pick)
          sampled_no_cases_list[[i]] <- chd_no_cases[pick, ]
        } else {
          stop("Not enough unique No-CHD cases to match all Yes-CHD cases.")
        }
      }
    } else {
      # If no No-CHD in state, sample from all unused No-CHD
      available_global <- setdiff(seq_len(nrow(chd_no_cases)), used_no_indices)
      if (length(available_global) > 0) {
        pick <- sample(available_global, 1)
        used_no_indices <- c(used_no_indices, pick)
        sampled_no_cases_list[[i]] <- chd_no_cases[pick, ]
      } else {
        stop("Not enough unique No-CHD cases to match all Yes-CHD cases.")
      }
    }
  }
  sampled_no_cases <- bind_rows(sampled_no_cases_list)
  Heart_clean_balanced <- bind_rows(chd_yes_cases, sampled_no_cases)
  cat(sprintf("\nTotal CHD Yes cases: %d\n", nrow(chd_yes_cases)))
  cat(sprintf("\nTotal CHD No cases sampled: %d\n", nrow(sampled_no_cases)))
  cat(sprintf("\nTotal balanced dataset size: %d (matched by State_Code without duplicates)\n", nrow(Heart_clean_balanced)))
  Heart_clean <- Heart_clean_balanced
  cat(sprintf("\nHeart_clean dataset updated with state-matched random sampling (no duplicates)\n"))
  cat(sprintf("\nPerfect 50/50 balance achieved: %d Yes cases, %d No cases\n", 
              sum(Heart_clean$Coronary_Heart_Disease == "Yes"),
              sum(Heart_clean$Coronary_Heart_Disease == "No")))
}
```

---

# Descriptive Statistics
```{r, results='asis'}
# Display first few rows of the dataset in a styled box
kable(head(Heart_clean[, 1:6]), caption = "Final Dataset Preview with few variables", align = 'c', format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"), full_width = FALSE, position = "left")

rows_final <- nrow(Heart_clean)
cat(sprintf("Total rows dropped during cleaning: %d\n", rows_initial - rows_final))
cat(sprintf("Initial dataset size: %d rows\n", rows_initial))
cat(sprintf("Final cleaned dataset size: %d rows\n", rows_final))
```

---

# Data Visualizations

## Diabetes Status Distribution
```{r, results='asis'}
ggplot(Heart_clean, aes(x = Diabetes_Status)) +
  geom_bar(fill = "forestgreen") +
  labs(x = "Diabetes Status", y = "Count")
```

*Most samples have some form of diabetes, especially pregnancy-related.*

## Smoking Status Distribution
```{r, results='asis'}
ggplot(Heart_clean, aes(x = Smoking_Status)) +
  geom_bar(fill = "red") +
  labs(x = "Smoking Status", y = "Count")
```

*Non-smokers slightly outnumber smokers.*

## General Health Status Distribution
```{r}
ggplot(Heart_clean, aes(x = General_Health_Status)) +
  geom_bar(fill = "blue") +
  labs(x = "General Health Status", y = "Count")
```

*Most samples report good health; poor health is least common.*

## Exercise in Past 30 Days
```{r}
ggplot(Heart_clean, aes(x = Exercise_Past_30_Days)) +
  geom_bar(fill = "purple") +
  labs(x = "Exercise Past 30 Days", y = "Count")
```

*Most samples exercised in the past 30 days.*

## BMI Category Distribution
```{r}
ggplot(Heart_clean, aes(x = BMI_Category_Alt)) +
  geom_bar(fill = "orange") +
  labs(x = "BMI Category", y = "Count")
```

*Most samples are in the normal and obese BMI ranges.*

## BMI Value Distribution
```{r}
ggplot(na.omit(Heart_clean), aes(x = BMI_Value)) +
  geom_histogram(binwidth = 2, fill = "skyblue", color = "black") +
  labs(x = "BMI Value", y = "Count")
```

*BMI is right-skewed, concentrated in the 20–40 range.*

## Sex Distribution
```{r}
# Bar plot for overall sex distribution in the dataset
ggplot(Heart_clean, aes(x = Sex, fill = Sex)) +
  geom_bar(show.legend = FALSE) +
  labs(
    title = "Sex Distribution in the Dataset",
    x = "Sex",
    y = "Count"
  ) +
  scale_fill_manual(values = c("Male" = "#619CFF", "Female" = "#F8766D")) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))

# Print counts and proportions
sex_table <- table(Heart_clean$Sex)
cat("\n=== Sex Distribution (Counts) ===\n")
print(sex_table)
cat("\n=== Sex Distribution (Percentages) ===\n")
sex_prop <- prop.table(sex_table) * 100
print(round(sex_prop, 2))
```

*The plot and table show the overall male/female distribution in the cleaned dataset. Percentages reflect the study population after cleaning and balancing.*

## Age Distribution
```{r, fig.width=10, fig.height=6}
# Bar plot for overall age group distribution in the dataset
ggplot(Heart_clean, aes(x = Age, fill = Age)) +
  geom_bar(show.legend = FALSE) +
  labs(
    title = "Age Group Distribution in the Dataset",
    x = "Age Group",
    y = "Count"
  ) +
  scale_fill_brewer(palette = "Set3") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Print counts and proportions
age_table <- table(Heart_clean$Age)
cat("\n=== Age Group Distribution (Percentages) ===\n")
age_prop <- prop.table(age_table) * 100
print(round(age_prop, 2))
```

*The plot and table show the age group distribution in the cleaned dataset. Older age groups are more represented, which may relate to higher CHD risk.*

---

# Data Analysis

## Q1: Is there a significant difference in BMI between people with and without coronary heart disease?

**Rationale:**

- We want to compare the mean BMI between two independent groups (CHD: Yes vs No). The t-test is appropriate for comparing means of a continuous variable between two groups.

**Hypothesis:**

- Null hypothesis (H0): The mean BMI is the same for people with and without coronary heart disease.
- Alternative hypothesis (H1): The mean BMI differs between people with and without coronary heart disease.

**Statistical Test:** T-test (comparing means of two groups)
```{r}
aggregate(BMI_Value ~ Coronary_Heart_Disease, data = Heart_clean, 
          FUN = function(x) c(mean = mean(x, na.rm = TRUE), sd = sd(x, na.rm = TRUE), count = length(x[!is.na(x)])))
boxplot(BMI_Value ~ Coronary_Heart_Disease, data = Heart_clean,
        main = "BMI by Coronary Heart Disease Status",
        xlab = "Coronary Heart Disease", ylab = "BMI",
        col = c("lightblue", "coral"))
t_test_bmi <- t.test(BMI_Value ~ Coronary_Heart_Disease, data = Heart_clean, conf.level = 0.95)
print(t_test_bmi)
if(t_test_bmi$p.value < 0.05) {
  cat("Result: There is a significant difference in BMI between groups (p < 0.05)")
} else {
  cat("Result: There is no significant difference in BMI between groups (p >= 0.05)")
}
```

*The t-test shows a strong difference in BMI between people with and without CHD (p < 2e-16). Individuals with CHD tend to have higher BMI on average.*


---

## Q2: Is smoking status associated with coronary heart disease?

**Rationale:**

- We are testing the association between two categorical variables (smoking status and CHD). The chi-square test of independence is suitable for this purpose.

**Hypothesis:**

- Null hypothesis (H0): Smoking status and coronary heart disease are independent (no association).
- Alternative hypothesis (H1): Smoking status and coronary heart disease are associated.

**Statistical Test:** Chi-square test (testing association between two categorical variables)

```{r}
smoking_table <- table(Heart_clean$Smoking_Status, Heart_clean$Coronary_Heart_Disease)
print(smoking_table)
prop_table <- prop.table(smoking_table, margin = 1) * 100
print(round(prop_table, 1))
barplot(smoking_table, beside = TRUE,
        xlab = "Coronary Heart Disease", ylab = "Count",
        col = c("lightgreen", "pink"),
        legend = TRUE)
chi_test_smoking <- chisq.test(smoking_table)
print(chi_test_smoking)
if(chi_test_smoking$p.value < 0.05) {
  cat("Result: There is a significant association between smoking and coronary heart disease (p < 0.05)")
} else {
  cat("Result: There is no significant association between smoking and coronary heart disease (p >= 0.05)")
}
```

*The chi-squared test shows a strong relationship between smoking and CHD (p < 2e-16). Smokers are more likely to have CHD than non-smokers.*

---

## Q3: Is diabetes status associated with coronary heart disease?

**Rationale:**

- We are testing the association between two categorical variables (diabetes status and CHD). The chi-square test of independence is suitable.

**Hypothesis:**

- Null hypothesis (H0): Diabetes status and coronary heart disease are independent (no association).
- Alternative hypothesis (H1): Diabetes status and coronary heart disease are associated (not independent).

**Statistical Test:** Chi-square test (testing association between two categorical variables)

```{r}
diabetes_table <- table(Heart_clean$Diabetes_Status, Heart_clean$Coronary_Heart_Disease)
print(diabetes_table)
prop_table_diabetes <- prop.table(diabetes_table, margin = 1) * 100
print(round(prop_table_diabetes, 1))
barplot(diabetes_table, beside = TRUE, 
        main = "Diabetes Status and Coronary Heart Disease",
        xlab = "Coronary Heart Disease", ylab = "Count",
        col = c("yellow", "orange", "red", "green"),
        legend = TRUE)
chi_test_diabetes <- chisq.test(diabetes_table)
print(chi_test_diabetes)
if(chi_test_diabetes$p.value < 0.05) {
  cat("Result: There is a significant association between diabetes and coronary heart disease (p < 0.05)")
} else {
  cat("Result: There is no significant association between diabetes and coronary heart disease (p >= 0.05)")
}
```

*The chi-squared test shows a strong relationship between diabetes and CHD (p < 2e-16). People with diabetes have a much higher chance of CHD.*

---

## Q4: Is exercise participation associated with coronary heart disease?

**Rationale:**

- We are testing the association between two categorical variables (exercise participation and CHD). The chi-square test of independence is suitable.

**Hypothesis:**

- Null hypothesis (H0): Exercise participation and coronary heart disease are independent (no association).
- Alternative hypothesis (H1): Exercise participation and coronary heart disease are associated (not independent).

**Statistical Test:** Chi-square test (testing association between two categorical variables)

```{r}
exercise_chd_table <- table(Heart_clean$Exercise_Past_30_Days, Heart_clean$Coronary_Heart_Disease)
print(exercise_chd_table)
prop_exercise_chd <- prop.table(exercise_chd_table, margin = 1) * 100
print(round(prop_exercise_chd, 1))
barplot(exercise_chd_table, beside = TRUE,
        main = "Exercise Participation and Coronary Heart Disease",
        xlab = "Coronary Heart Disease", ylab = "Count",
        col = c("#6a5acd", "#ffb347"),
        legend = TRUE)
chi_test_exercise <- chisq.test(exercise_chd_table)
print(chi_test_exercise)
if(chi_test_exercise$p.value < 0.05) {
  cat("Result: There is a significant association between exercise participation and coronary heart disease (p < 0.05)")
} else {
  cat("Result: There is no significant association between exercise participation and coronary heart disease (p >= 0.05)")
}
```

*The chi-squared test shows exercise participation is associated with CHD. People who exercise may have a different CHD risk than those who do not.*

---

## Q5: Is general health status associated with coronary heart disease?

**Rationale:**

- We are testing the association between two categorical variables (general health status and CHD). The chi-square test of independence is suitable for this purpose.

**Hypothesis:**

- Null hypothesis (H0): General health status and coronary heart disease are independent (no association).
- Alternative hypothesis (H1): General health status and coronary heart disease are associated.

**Statistical Test:** Chi-square test (testing association between two categorical variables)

```{r}
gh_chd_table <- table(Heart_clean$General_Health_Status, Heart_clean$Coronary_Heart_Disease)
print(gh_chd_table)
prop_gh_chd <- prop.table(gh_chd_table, margin = 1) * 100
print(round(prop_gh_chd, 1))
barplot(t(gh_chd_table), beside = TRUE,
        main = "General Health Status and Coronary Heart Disease",
        xlab = "General Health Status", ylab = "Count",
        col = c("#2ecc71", "#e74c3c"),
        legend = colnames(gh_chd_table))
chi_test_gh <- chisq.test(gh_chd_table)
print(chi_test_gh)
if(chi_test_gh$p.value < 0.05) {
  cat("Result: There is a significant association between general health status and coronary heart disease (p < 0.05)")
} else {
  cat("Result: There is no significant association between general health status and coronary heart disease (p >= 0.05)")
}
```

*The chi-squared test shows general health status is associated with CHD. People reporting poorer health have a higher CHD risk.*

---

## Q6: Is age group associated with coronary heart disease?

**Rationale:**

- We are testing the association between two categorical variables (age group and CHD). The chi-square test of independence is suitable for this purpose.

**Hypothesis:**

- Null hypothesis (H0): Age group and coronary heart disease are independent (no association).
- Alternative hypothesis (H1): Age group and coronary heart disease are associated.

**Statistical Test:** Chi-square test (testing association between two categorical variables)

```{r}
age_chd_table <- table(Heart_clean$Age, Heart_clean$Coronary_Heart_Disease)
print(age_chd_table)
prop_age_chd <- prop.table(age_chd_table, margin = 1) * 100
print(round(prop_age_chd, 1))
# barplot(t(age_chd_table), beside = TRUE,
#         main = "Age Group and Coronary Heart Disease",
#         xlab = "Age Group", ylab = "Count",
#         col = c("#2ecc71", "#e74c3c"),
#         legend = colnames(age_chd_table))

# Create a grouped bar plot for Age vs CHD
ggplot(Heart_clean, aes(x = Age, fill = Coronary_Heart_Disease)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Age Distribution by Coronary Heart Disease Status",
    x = "Age Group",
    y = "Count",
    fill = "CHD Status"
  ) +
  scale_fill_manual(values = c("Yes" = "#e74c3c", "No" = "#2ecc71")) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )


chi_test_age <- chisq.test(age_chd_table)
print(chi_test_age)
if(chi_test_age$p.value < 0.05) {
  cat("Result: There is a significant association between age group and coronary heart disease (p < 0.05)")
} else {
  cat("Result: There is no significant association between age group and coronary heart disease (p >= 0.05)")
}
```
*Older age groups (50-69) have much higher CHD rates than younger groups. The chi-squared test confirms age group is associated with CHD.*


---

## Q7: Is sex associated with coronary heart disease?

**Rationale:**

- We are testing the association between two categorical variables (sex and CHD). The chi-square test of independence is suitable.

**Hypothesis:**

- Null hypothesis (H0): Sex and coronary heart disease are independent (no association).
- Alternative hypothesis (H1): Sex and coronary heart disease are associated (not independent).

**Statistical Test:** Chi-square test (testing association between two categorical variables)

```{r}
sex_chd_table <- table(Heart_clean$Sex, Heart_clean$Coronary_Heart_Disease)
print(sex_chd_table)
prop_sex_chd <- prop.table(sex_chd_table, margin = 1) * 100
print(round(prop_sex_chd, 1))
barplot(t(sex_chd_table), beside = TRUE,
        main = "Sex and Coronary Heart Disease",
        xlab = "Sex", ylab = "Count",
        col = c("#2ecc71", "#e74c3c"),
        legend = colnames(sex_chd_table))
chi_test_sex <- chisq.test(sex_chd_table)
print(chi_test_sex)
if(chi_test_sex$p.value < 0.05) {
  cat("Result: There is a significant association between sex and coronary heart disease (p < 0.05)")
} else {
  cat("Result: There is no significant association between sex and coronary heart disease (p >= 0.05)")
}
```

*The chi-squared test shows sex is associated with CHD (p < 0.05). Males have a higher proportion of CHD than females.*

---

# Model Building and Training for CHD Prediction

## Final Data Overview and Class Distribution
```{r}
# Display summary statistics for key variables
summary(Heart_clean[, c("Coronary_Heart_Disease", "Age", "Sex", "Smoking_Status", 
                       "Diabetes_Status", "Exercise_Past_30_Days", "General_Health_Status")])

# Check class distribution
chd_distribution <- table(Heart_clean$Coronary_Heart_Disease)
print("Coronary Heart Disease Distribution:")
print(chd_distribution)
cat("Imbalance ratio (No:Yes):", round(chd_distribution["No"]/chd_distribution["Yes"], 1), ":1\n")
```

---

## Data Splitting and Preparation

```{r}
library(caret)
library(rpart)
library(rpart.plot)

set.seed(123)  # For reproducibility

# Create stratified train/test split (80/20)
train_index <- createDataPartition(Heart_clean$Coronary_Heart_Disease, p = 0.8, list = FALSE)
train_data <- Heart_clean[train_index, ]
test_data <- Heart_clean[-train_index, ]

cat("Training set size:", nrow(train_data), "\n")
cat("Test set size:", nrow(test_data), "\n")

# Check class distribution in training data
train_class_dist <- table(train_data$Coronary_Heart_Disease)
print("Training data class distribution:")
print(train_class_dist)

# Print the overall CHD Yes count in training data
cat("Overall CHD Yes count in training data:", train_class_dist["Yes"], "\n")
```

---

## Random Forest Model Training
```{r}
library(dplyr)
library(caret)
library(ranger)
library(pROC)

# Select the key predictors (justified by statistical tests above)
rf_df <- Heart_clean %>%
  select(Age, Sex, Coronary_Heart_Disease, Smoking_Status, Diabetes_Status,
         Exercise_Past_30_Days, General_Health_Status, BMI_Value) %>%
  na.omit()

# Ensure correct data types
rf_df <- rf_df %>%
  mutate(across(c(Age, Sex, Smoking_Status, Diabetes_Status, 
                  Exercise_Past_30_Days, General_Health_Status,
                  Coronary_Heart_Disease), as.factor))

# Split the dataset
set.seed(123)
train_index <- createDataPartition(rf_df$Coronary_Heart_Disease, p = 0.7, list = FALSE)

train_rf <- rf_df[train_index, ]
test_rf  <- rf_df[-train_index, ]

# Train RF with optimized parameters for small dataset
set.seed(123)

rf_orig <- ranger(
  formula = Coronary_Heart_Disease ~ .,
  data = train_rf,
  num.trees = 500,           # Good for small datasets (500-1000 is standard)
  mtry = floor(sqrt(ncol(train_rf) - 1)),  # Standard for classification (√p)
  importance = "permutation",  # Good choice for interpretability
  min.node.size = 5,          # Reduced from 10 to allow finer splits with small dataset
  probability = TRUE,
  sample.fraction = 0.7,      # Use 70% of training data per tree (helps with small datasets)
  replace = TRUE              # Bootstrap sampling (default, but explicit for clarity)
)

rf_orig
```
---

## Random Forest Model evaluation 
```{r}
# Predict probabilities (extract "Yes" column)
pred_prob_orig <- predict(rf_orig, data = test_rf)$predictions[, "Yes"]

# ROC + optimal cutoff (Youden)
roc_obj_rf <- roc(test_rf$Coronary_Heart_Disease, pred_prob_orig)
best <- coords(roc_obj_rf, "best", best.method = "youden", ret = c("threshold","sensitivity","specificity"))
print(best)
optimal_cutoff_rf <- best$threshold[1]

# Classify with optimal cutoff
pred_class_rf_opt <- factor(ifelse(pred_prob_orig >= optimal_cutoff_rf, "Yes", "No"),
                            levels = c("No","Yes"))

# Confusion matrix + metrics
conf_opt <- confusionMatrix(pred_class_rf_opt, test_rf$Coronary_Heart_Disease)
print(conf_opt)

TP <- conf_opt$table[2,2]
TN <- conf_opt$table[1,1]
FP <- conf_opt$table[1,2]
FN <- conf_opt$table[2,1]

# Calculate additional metrics
metrics_df <- data.frame(
  Metric = c("Accuracy", "Precision", "Recall", "F1-score", "Specificity"),
  Value  = round(c(
    (TP + TN) / (TP + TN + FP + FN),
    ifelse((TP + FP) == 0, NA, TP / (TP + FP)),
    ifelse((TP + FN) == 0, NA, TP / (TP + FN)),
    ifelse((TP + FP) == 0 | (TP + FN) == 0, NA, 2 * ( (TP / (TP + FP)) * (TP / (TP + FN)) / ((TP / (TP + FP)) + (TP / (TP + FN))) )),
    ifelse((TN + FP) == 0, NA, TN / (TN + FP))
  ), 4)
)
print(metrics_df)

# Print AUC for reference
cat("AUC:", round(as.numeric(auc(roc_obj_rf)), 4), "\n")

```
```{r}
# --- Variable Importance Plot ---
# Extract and prepare importance
var_imp <- as.data.frame(rf_orig$variable.importance)
var_imp$Variable <- rownames(var_imp)
colnames(var_imp)[1] <- "Importance"
var_imp <- var_imp[order(var_imp$Importance, decreasing = TRUE), ]

# Plot variable importance
ggplot(var_imp, aes(x = reorder(Variable, Importance), y = Importance)) +
  geom_col(fill = "#249bd3") +
  coord_flip() +
  labs(title = "Random Forest Variable Importance",
       x = "Variable", y = "Importance (Permutation)") +
  theme_minimal()
```

---

## Categorical Tree Model Training

```{r}
library(rpart)
library(rpart.plot)
library(caret)

# Use the same train/test split as Random Forest (already created above)

# Train Decision Tree with complexity parameter tuning
set.seed(123)

# Build initial tree
tree_model <- rpart(
  formula = Coronary_Heart_Disease ~ Age + Sex + Smoking_Status + Diabetes_Status + 
                                      Exercise_Past_30_Days + General_Health_Status + BMI_Value,
  data = train_rf,
  method = "class",
  control = rpart.control(
    cp = 0.001,        # Complexity parameter (lower = more splits)
    minsplit = 20,     # Minimum observations to attempt split
    minbucket = 10,    # Minimum observations in terminal node
    maxdepth = 10      # Maximum tree depth
  )
)

# Print tree summary
cat("=== Decision Tree Model Summary ===\n")
print(tree_model)

# Display complexity parameter table
cat("\n=== Complexity Parameter Table ===\n")
printcp(tree_model)

# Find optimal CP (minimum xerror)
optimal_cp <- tree_model$cptable[which.min(tree_model$cptable[,"xerror"]),"CP"]
cat(sprintf("\nOptimal Complexity Parameter (CP): %.5f\n", optimal_cp))

# Prune tree to optimal CP
tree_pruned <- prune(tree_model, cp = optimal_cp)

cat("\n=== Pruned Decision Tree Summary ===\n")
print(tree_pruned)
```

## Decision Tree Visualization

```{r, fig.width=14, fig.height=10}
# Visualize the pruned decision tree
rpart.plot(
  tree_pruned,
  type = 4,              # Display all node labels
  extra = 101,           # Display number of observations and percentage
  fallen.leaves = TRUE,  # Put leaves at bottom
  branch.lty = 3,        # Dotted branch lines
  shadow.col = "gray",   # Add shadow
  box.palette = "RdYlGn", # Red-Yellow-Green color scheme
  main = "Decision Tree for Coronary Heart Disease Prediction\n(Pruned with Optimal CP)",
  cex.main = 1.3,
  digits = 3,
  tweak = 1.2            # Scale text size
)

```

## Decision Tree Performance Evaluation

```{r}
# Predict on test set
tree_pred_class <- predict(tree_pruned, newdata = test_rf, type = "class")
tree_pred_prob <- predict(tree_pruned, newdata = test_rf, type = "prob")[, "Yes"]

# Confusion Matrix
conf_tree <- confusionMatrix(tree_pred_class, test_rf$Coronary_Heart_Disease)

# Display confusion matrix (compact output)
print(conf_tree)

# Extract metrics
TP_tree <- conf_tree$table[2,2]
TN_tree <- conf_tree$table[1,1]
FP_tree <- conf_tree$table[1,2]
FN_tree <- conf_tree$table[2,1]

# Calculate comprehensive metrics
metrics_tree <- data.frame(
  Metric = c("Accuracy", "Precision (PPV)", "Recall (Sensitivity)", "Specificity", "F1-Score", "AUC"),
  Value  = round(c(
    (TP_tree + TN_tree) / (TP_tree + TN_tree + FP_tree + FN_tree),
    ifelse((TP_tree + FP_tree) == 0, NA, TP_tree / (TP_tree + FP_tree)),
    ifelse((TP_tree + FN_tree) == 0, NA, TP_tree / (TP_tree + FN_tree)),
    ifelse((TN_tree + FP_tree) == 0, NA, TN_tree / (TN_tree + FP_tree)),
    ifelse((TP_tree + FP_tree) == 0 | (TP_tree + FN_tree) == 0, NA, 
           2 * ((TP_tree / (TP_tree + FP_tree)) * (TP_tree / (TP_tree + FN_tree))) / 
               ((TP_tree / (TP_tree + FP_tree)) + (TP_tree / (TP_tree + FN_tree)))),
    as.numeric(pROC::auc(pROC::roc(test_rf$Coronary_Heart_Disease, tree_pred_prob)))
  ), 4),
  Percentage = paste0(round(c(
    (TP_tree + TN_tree) / (TP_tree + TN_tree + FP_tree + FN_tree),
    ifelse((TP_tree + FP_tree) == 0, NA, TP_tree / (TP_tree + FP_tree)),
    ifelse((TP_tree + FN_tree) == 0, NA, TP_tree / (TP_tree + FN_tree)),
    ifelse((TN_tree + FP_tree) == 0, NA, TN_tree / (TN_tree + FP_tree)),
    ifelse((TP_tree + FP_tree) == 0 | (TP_tree + FN_tree) == 0, NA, 
           2 * ((TP_tree / (TP_tree + FP_tree)) * (TP_tree / (TP_tree + FN_tree))) / 
               ((TP_tree / (TP_tree + FP_tree)) + (TP_tree / (TP_tree + FN_tree)))),
    as.numeric(pROC::auc(pROC::roc(test_rf$Coronary_Heart_Disease, tree_pred_prob)))
  ) * 100, 2), "%")
)

# Display metrics table
kable(metrics_tree, 
      caption = "Decision Tree Model Performance Metrics",
      align = 'c') %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)

```

## Variable Importance in Decision Tree

```{r, results='asis', fig.width=10, fig.height=6}
# Extract variable importance from decision tree
tree_importance <- tree_pruned$variable.importance

if(length(tree_importance) > 0) {
  # Convert to data frame
  tree_var_imp <- data.frame(
    Variable = names(tree_importance),
    Importance = as.numeric(tree_importance)
  )
  tree_var_imp <- tree_var_imp[order(tree_var_imp$Importance, decreasing = TRUE), ]
  
  # Plot variable importance
  ggplot(tree_var_imp, aes(x = reorder(Variable, Importance), y = Importance)) +
    geom_col(fill = "#e74c3c") +
    coord_flip() +
    labs(title = "Decision Tree Variable Importance",
         subtitle = "Based on total decrease in node impurity",
         x = "Variable", 
         y = "Importance") +
    theme_minimal() +
    theme(plot.title = element_text(hjust = 0.5, face = "bold"),
          plot.subtitle = element_text(hjust = 0.5))
  
  # Print importance table (remove print() for proper HTML rendering)
  cat("\n=== Decision Tree Variable Importance ===\n")
  kable(tree_var_imp, 
        caption = "Variables Ranked by Importance in Decision Tree",
        align = 'c',
        row.names = FALSE) %>%
    kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
} else {
  cat("No variable importance available (tree may be too simple)\n")
}
```

## ROC Curve Comparison: Random Forest vs Decision Tree

```{r, fig.width=10, fig.height=6}
# Create ROC curves for both models
roc_rf <- pROC::roc(test_rf$Coronary_Heart_Disease, pred_prob_orig)
roc_tree <- pROC::roc(test_rf$Coronary_Heart_Disease, tree_pred_prob)

# Plot comparison
plot(roc_rf, col = "#1c61b6", lwd = 3, main = "ROC Curve Comparison: Random Forest vs Decision Tree",
     xlab = "False Positive Rate (1 - Specificity)", 
     ylab = "True Positive Rate (Sensitivity)")
plot(roc_tree, col = "#e74c3c", lwd = 3, add = TRUE)
abline(a = 0, b = 1, lty = 2, col = "gray")
legend("bottomright", 
       legend = c(paste0("Random Forest (AUC = ", round(pROC::auc(roc_rf), 3), ")"),
                  paste0("Decision Tree (AUC = ", round(pROC::auc(roc_tree), 3), ")"),
                  "Random Classifier"),
       col = c("#1c61b6", "#e74c3c", "gray"),
       lwd = c(3, 3, 2),
       lty = c(1, 1, 2))
```

## Model Comparison: Random Forest vs Decision Tree

```{r, results='asis'}
# Get AUC for Random Forest (it was printed separately)
rf_auc <- as.numeric(auc(roc_obj_rf))

# Create comparison table with matching metrics
model_comparison <- data.frame(
  Metric = c("Accuracy", "Precision", "Sensitivity", "Specificity", "F1-Score", "AUC"),
  Random_Forest = c(
    metrics_df$Value[1],  # Accuracy
    metrics_df$Value[2],  # Precision
    metrics_df$Value[3],  # Recall/Sensitivity
    metrics_df$Value[5],  # Specificity
    metrics_df$Value[4],  # F1-score
    rf_auc                # AUC
  ),
  Decision_Tree = metrics_tree$Value,
  stringsAsFactors = FALSE
)

# Calculate difference
model_comparison$Difference <- model_comparison$Random_Forest - model_comparison$Decision_Tree

# Add percentage columns
model_comparison$RF_Pct <- paste0(round(model_comparison$Random_Forest * 100, 2), "%")
model_comparison$DT_Pct <- paste0(round(model_comparison$Decision_Tree * 100, 2), "%")
model_comparison$Diff_Pct <- paste0(ifelse(model_comparison$Difference > 0, "+", ""), 
                                     round(model_comparison$Difference * 100, 2), "%")

# Display comparison (remove print() for proper HTML rendering)
kable(model_comparison[, c("Metric", "RF_Pct", "DT_Pct", "Diff_Pct")], 
      caption = "Model Performance Comparison: Random Forest vs Decision Tree",
      align = 'c',
      col.names = c("Metric", "Random Forest", "Decision Tree", "Difference (RF - DT)"),
      row.names = FALSE) %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"), full_width = FALSE)

```
---

# Conclusion


This analysis found that age, sex, high BMI, diabetes, and smoking are strongly linked to higher CHD risk. Regular physical activity is also associated with CHD. These results highlight the importance of healthy lifestyle choices for CHD prevention.

A supervised AI web application has been developed and hosted in GitHub to predict CHD risk using the above decision tree model trained on the BRFSS 2024 dataset. This interactive tool leverages supervised machine learning to estimate individual CHD risk based on user input. Try the CHD risk prediction demo here: [https://dhanushgwu1995.github.io/6101-mid-term-project/predict](https://dhanushgwu1995.github.io/6101-mid-term-project/predict)

## Limitations
- Results are based on available data with some missing values
- Cross-sectional data limits causal conclusions

## Practical Implications
These results help identify key CHD risk factors and can guide screening, public health interventions, and patient care to reduce CHD through lifestyle changes.

## References

Tsao, C. W., & Vasan, R. S. (2015). Cohort profile: The Framingham Heart Study (FHS): Overview of milestones in cardiovascular epidemiology. *International Journal of Epidemiology*, *44*(6), 1800–1813. https://doi.org/10.1093/ije/dyv337

Yusuf, S., Hawken, S., Ounpuu, S., Dans, T., Avezum, A., Lanas, F., McQueen, M., Budaj, A., Pais, P., Varigos, J., Liu, L., & INTERHEART Study Investigators. (2004). Effect of potentially modifiable risk factors associated with myocardial infarction in 52 countries (the INTERHEART study): Case-control study. *The Lancet*, *364*(9438), 937–952. https://doi.org/10.1016/S0140-6736(04)17018-9

